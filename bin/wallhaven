#!/usr/bin/env python3

import requests
from bs4 import BeautifulSoup
from sh import wget, feh
from argparse import ArgumentParser
from random import randint

parser = ArgumentParser()
parser.add_argument("search")
parser.add_argument("-views", action="store_const", const=1)
parser.add_argument("-random", action="store_const", const=1)
parser.add_argument("-nsfw", action="store_const", const=1)
parser.add_argument("-nsfwonly", action="store_const", const=1)
parser.add_argument("-page")
args = parser.parse_args()

# Set URL
url = "http://alpha.wallhaven.cc/search?q={}&purity={}&sorting={}&page={}"\
        .format(args.search,
                "111" if args.nsfw else "011" if args.nsfwonly else "100",\
                "views" if args.views else "random" if args.random else "relevance",\
                randint(1, 5) if not args.page else args.page)

# Get list of wallpapers
html = requests.get(url).text
soup = BeautifulSoup(html)
wall = soup.find_all("a", {"class": "preview"})
if not wall: exit("No wallpapers found.")

# Get random wallpaper from search results
wall = wall[randint(0, len(wall))]
html = requests.get("{}".format(wall.get("href"))).text
soup = BeautifulSoup(html)
wall = soup.find("img", {"id": "wallpaper"})

# Download and set wallpaper
wget("-q", "-O", "/home/joe/Pictures/.wallhaven", wall.get("src")[2:])
feh("--bg-scale", "--no-fehbg", "/home/joe/Pictures/.wallhaven")
